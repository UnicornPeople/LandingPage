# dev.yml
name: dev branch auto ci process script

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to checkout'  

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest # ì‹¤í–‰ë  ì¸ìŠ¤í„´ìŠ¤ OSì™€ ë²„ì „

    steps:      
      - name: excuting remote ssh commands
        uses: appleboy/ssh-action@v0.1.6 # ssh ì ‘ì†í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤
        with:
          host: "3.37.89.157" 
          username: "ubuntu" 
          key: ${{ secrets.API_SERVER_KEY }} # ec2 instance pem key
          port: 22
          script: | # ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
            echo "ðŸš§ Start deployemnt"
            cd /home/ubuntu/workspace/frontend/skill-coach
            echo "ðŸš§ Get Code"
            git reset --hard "HEAD^"
            git clean -df
            git pull --no-rebase origin develop
            echo "ðŸš§ Create env"
            sudo echo "REACT_APP_API_KEY=${{ secrets.REACT_APP_API_KEY }}" > ".env.development"
            sudo echo "REACT_APP_AUTH_DOMAIN=${{ secrets.REACT_APP_AUTH_DOMAIN }}" >> ".env.development"
            sudo echo "REACT_APP_ID=${{ secrets.REACT_APP_ID }}" >> ".env.development"
            sudo echo "REACT_APP_PROJECT_ID=${{ secrets.REACT_APP_PROJECT_ID }}" >> ".env.development"
            sudo echo "REACT_APP_STORAGE_BUCKET=${{ secrets.REACT_APP_STORAGE_BUCKET }}" >> ".env.development"
            sudo echo "REACT_APP_MESSAGING_SENDER_ID=${{ secrets.REACT_APP_MESSAGING_SENDER_ID }}" >> ".env.development"
            sudo echo "REACT_APP_MEASUREMENT_IDL=${{ secrets.REACT_APP_MEASUREMENT_IDL }}" >> ".env.development"
            echo "ðŸš§ Waiting for npm initializaing"            
            sudo npm install 
            export NODE_OPTIONS=--max_old_space_size=2048 
            echo "ðŸš§ Start server"
            sudo systemctl restart skillcoach-web


            
